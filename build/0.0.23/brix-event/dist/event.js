define("brix/event",["jquery","underscore"],function(jQuery,_){function EventManager(e){return this instanceof EventManager?void(this.prefix=e||PREFIX):new EventManager(e)}function _delegateBxTypeEvents(e,t,r){var n=jQuery(document.body),a=jQuery(t),o=a.data();if(o){o[BX_EVENT_SEPARATION+e]=Math.random(),o[BX_EVENT_CACHE+e]||(o[BX_EVENT_CACHE+e]={});var E=_parseBxTypes(e,t);_.each(E,function(a){function E(t){if(!jQuery(t.target).closest(".disabled").length&&closestSeparation(e,t.currentTarget)===o[BX_EVENT_SEPARATION+e]){var n=[].slice.call(arguments,1);t.owner=r,t.component=function(){try{return require("brix/loader").query(t.currentTarget)[0]}catch(e){}}(),entrees.apply(this,[t,r,e].concat(n))}}var p=e+a,s="["+p+"]";if(!o[BX_EVENT_CACHE+e][p]){if(DEBUG&&console.log(DEBUG.fix(a,16),p),RE_TARGET_TYPE.exec(""),RE_TARGET_TYPE.exec(a))return void _delegateBxTargetType(e,a,t,r);n.on(a+BX_EVENT_NAMESPACE,s,E),o[BX_EVENT_CACHE+e][p]={type:a,bxtype:p,namespace:BX_EVENT_NAMESPACE,selector:s,appetizer:E}}})}}function entrees(event,owner,prefix){var extraParameters=[].slice.call(arguments,3),handler=jQuery(event.currentTarget).attr(prefix+event.type);if(handler){var parts=_parseMethodAndParams(handler);parts&&owner[parts.method]?owner[parts.method].apply(owner,[event].concat(extraParameters).concat(parts.params)):eval(handler)}}function closestSeparation(e,t){var r=jQuery(t).data(BX_EVENT_SEPARATION+e);if(!r)for(var n=jQuery(t).parents(),a=0;a<n.length;a++)if(n.eq(a).data(BX_EVENT_SEPARATION+e)){r=n.eq(a).data(BX_EVENT_SEPARATION+e);break}return r}function _undelegateBxTypeEvents(e,t){var r=jQuery(document.body),n=jQuery(t),a=n.data();a&&(_.each(a[BX_EVENT_CACHE+e],function(n,a){return RE_TARGET_TYPE.exec(""),RE_TARGET_TYPE.exec(n.type)?void _undelegateBxTargetTypeEvents(e,n.type,t):void r.off(n.type+n.namespace,n.selector,n.appetizer)}),a[BX_EVENT_CACHE+e]={})}function _delegateBxTargetType(prefix,type,element,owner){function _bxTargetTypeAppetizer(e){var t=e.type;e.type=bxtype,jQuery(e.target).trigger(e,[].slice.call(arguments,1)),e.type=t}function _bxTargetTypeEntrees(event){var selector="["+prefix+type+"]",$targets=function(){var e=[];jQuery(event.target).is(selector)&&e.push(event.target);var t=jQuery(event.target).parentsUntil(element,selector);return e=e.concat(t.toArray()),jQuery(e)}(),currentType=event.type,originalType=ma[2];event.type=originalType;var extraParameters=[].slice.call(arguments,2);_.each($targets,function(item){var handler=jQuery(item).attr(currentType);if(handler){var parts=_parseMethodAndParams(handler);parts&&owner[parts.method]?owner[parts.method].apply(owner,[event].concat(extraParameters).concat(parts.params)):eval(handler)}}),event.type=currentType}RE_TARGET_TYPE.exec("");var ma=RE_TARGET_TYPE.exec(type);if(!ma)throw"不支持 "+type;var bxtype=prefix+type,$target="window"===ma[1]&&jQuery(window)||"document"===ma[1]&&jQuery(document)||"body"===ma[1]&&jQuery(document.body);$target.on(ma[2]+BX_EVENT_NAMESPACE,_bxTargetTypeAppetizer),$target.on(bxtype+BX_EVENT_NAMESPACE,_bxTargetTypeEntrees)}function _undelegateBxTargetTypeEvents(e,t){RE_TARGET_TYPE.exec("");var r=RE_TARGET_TYPE.exec(t);if(!r)throw"不支持 "+t;var n=e+t,a="window"===r[1]&&jQuery(window)||"document"===r[1]&&jQuery(document)||"body"===r[1]&&jQuery(document.body);a.off(r[2]+BX_EVENT_NAMESPACE),a.off(n+BX_EVENT_NAMESPACE)}function _parseBxEvents(e,t){var r=new RegExp(e+"(?!name|options)(.+)"),n=[];if(!t.nodeType&&t.length)return _.each(t,function(t){n=n.concat(_parseBxEvents(e,t))}),n;var a=function(){for(var e=[t],r=t.getElementsByTagName("*"),n=0;n<r.length;n++)e.push(r[n]);return e}();return _.each(a,function(e){_.each(e.attributes,function(t){r.exec("");var a=r.exec(t.name);if(a){var o={target:e,type:a[1],handler:t.value};_.extend(o,_parseMethodAndParams(t.value)),n.push(o),e._bx_events||(e._bx_events={}),e._bx_events[o.type]=!0}})}),n}function _parseBxTypes(e,t){return _.unique(_.map(_parseBxEvents(e,t),function(e){return e.type})).sort()}function _parseMethodAndParams(handler){if(handler){var parts=RE_FN_ARGS.exec(handler),method,params;return parts&&parts[1]?{method:parts[1],params:eval("["+(parts[2]||"")+"]")}:void 0}}var DEBUG=~location.search.indexOf("brix.event.debug")&&{fix:function(e,t){for(var r=parseInt(t,10)-(""+e).length,n=0;r>n;n++)e+=" ";return e}},PREFIX="bx-",BX_EVENT_NAMESPACE="."+(Math.random()+"").replace(/\D/g,""),RE_FN_ARGS=/([^()]+)(?:\((.*)\))?/,RE_TARGET_TYPE=/^(window|document|body)-(.+)/,BX_EVENT_SEPARATION="bx-event-separation",BX_EVENT_CACHE="bx-event-cache";return EventManager.NAMESPACE=BX_EVENT_NAMESPACE,EventManager.prototype.delegate=function(e,t){e=e||document.body,t=t||window;var r=this.prefix+"event";return DEBUG&&(console.group(r),console.time(r),console.log(e)),_undelegateBxTypeEvents(this.prefix,e),_delegateBxTypeEvents(this.prefix,e,t),DEBUG&&(console.timeEnd(r),console.groupEnd(r)),this},EventManager.prototype.undelegate=function(e){return e=e||document.body,_undelegateBxTypeEvents(this.prefix,e),this},EventManager._delegateBxTypeEvents=_delegateBxTypeEvents,EventManager._undelegateBxTypeEvents=_undelegateBxTypeEvents,EventManager._parseBxTypes=_parseBxTypes,EventManager._parseBxEvents=_parseBxEvents,EventManager._parseMethodAndParams=_parseMethodAndParams,EventManager});