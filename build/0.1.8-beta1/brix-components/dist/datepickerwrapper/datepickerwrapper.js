define(["jquery","underscore","moment","brix/loader","components/base","brix/event","components/datepicker","../dialog/position.js","./datepickerwrapper.tpl.js"],function(t,e,i,n,s,a,r,o,l){function d(){}var c=/^input|textarea$/i,p=".datepickerwrapper",h=r.DATE_PATTERN,u=r.TIME_PATTERN,m=r.DATE_TIME_PATTERN,f=function(){var t=i(),e=t.get("date"),n={"今天":[i().startOf("day"),i().startOf("day")],"昨天":[i().startOf("day").subtract(1,"days"),i().startOf("day").subtract(1,"days")],"过去 7 天":[i().startOf("day").subtract(7,"days"),i().startOf("day").subtract(1,"days")],"本月":[i().startOf("day").subtract(e-1,"days"),i().startOf("day")],"上月":[i().startOf("day").startOf("month").subtract(1,"month"),i().startOf("day").startOf("month").subtract(1,"days")],"最近 15 天":[i().startOf("day").subtract(15,"days"),i().startOf("day").subtract(1,"days")]};return n}(),g={PENDING:"pending",ACTIVE:"active",INACTIVE:"inactive"};return d.DATE_PATTERN=h,d.TIME_PATTERN=u,d.DATE_TIME_PATTERN=m,d.SHORTCUTS=f,e.extend(d.prototype,s.prototype,{options:{placement:"bottom",align:"left",offset:{},mode:"signal",shortcuts:f,type:"date",dates:[],ranges:[],excludeds:[],unlimits:[]},init:function(){this.options.typeMap=r.typeMap(this.options.type),this.options.dates.length>1&&(this.options.mode="multiple"),this.options.dates.length||(this.options.dates=[i().startOf("day").format(h)]),this.options.shortcuts&&e.each(this.options.shortcuts,function(t){e.each(t,function(n,s){t[s]=i(n,e.isString(n)&&m)})}),this.options.range&&this.options.range.length&&(this.options.ranges=this.options.range),this.options.ranges=e.flatten(this.options.ranges||this.options.range),e.each(this.options.ranges,function(t,n,s){t&&(s[n]=i(t,e.isString(t)&&m))}),this.options._ranges=e.map(this.options.ranges,function(t){return t?t.format(h):void 0}),this.options._ranges="['"+this.options._ranges.join("','")+"']",this.options.excluded&&this.options.excluded.length&&(this.options.excludeds=this.options.excluded),this.options.excludeds=e.flatten(this.options.excludeds||this.options.excluded),e.each(this.options.excludeds,function(t,n,s){t&&(s[n]=i(t,e.isString(t)&&m))}),this.options._excludeds=e.map(this.options.excludeds,function(t){return t?t.format(h):void 0}),this.options._excludeds=this.options._excludeds.length?"['"+this.options._excludeds.join("','")+"']":"[]",l=this.options.template||l,this.options.css&&require("css!"+this.options.css)},render:function(){var i=this;this.$element=t(this.element),this.$relatedElement=t(e.template(l)(this.options)).insertAfter(this.$element);var n=t.Deferred();this["_"+this.options.mode](n);var s="click.datepickerwrapper_toggle_"+this.clientId;this.$element.off(s).on(s,function(t){i.toggle(t)});var r=this.$manager=new a("bx-");return r.delegate(this.$element,this),r.delegate(this.$relatedElement,this),this._autoHide(),n.promise()},val:function(t){var i=n.query("components/datepicker",this.$relatedElement);return t?(e.each(i,function(i,n){i.val(e.isArray(t)?t[n]:t)}),this.submit(),this):e.map(i,function(t){return t.val()})},range:function(t){var i=n.query("components/datepicker",this.$relatedElement);return t?(this.options.ranges=t=e.flatten(t),e.each(i,function(e){e.range(t)}),this):this.options.ranges},excluded:function(t){var i=n.query("components/datepicker",this.$relatedElement);return t?(this.options.excludeds=t=e.flatten(t),e.each(i,function(e){e.excluded(t)}),this):this.options.excludeds},_signal:function(i){var s=this;n.boot(!0,this.$relatedElement,function(){var a=n.query("components/datepicker",s.$relatedElement)[0];a.on("change.datepicker unchange.datepicker",function(i,n,a){if(!n)return i.preventDefault(),void i.stopPropagation();if(!(void 0!==a&&"date"!==a&&"time"!==a||s.options.typeMap.time&&"date"===a)){s.hide();var r=t.Event("change"+p);if(s.trigger(r,[[n],a]),!r.isDefaultPrevented()){var o=s._unlimitFilter(n,s.options.unlimits[0]),l=t("[data-index]",s.$element);l.length?e.each(l,function(e,i){var n=t(e);n[c.test(e.nodeName)?"val":"html"](o)}):s.$element[c.test(s.element.nodeName)?"val":"html"](o),s.$element.triggerHandler("change"),c.test(s.element.nodeName)||t("[data-hidden-index]",s.$element).val(o).triggerHandler("change")}}}),a.$element.on("click",".timepicker .timepicker-footer .cancel",function(){s.hide()}),i&&i.resolve()})},_multiple:function(s){var a=this;n.boot(!0,this.$relatedElement,function(){var r=t(".datepickerwrapper-inputs",a.$relatedElement),o=t("input",r),l=t(".datepickerwrapper-pickers",a.$relatedElement),d=t(".picker",l),c=n.query("components/datepicker",a.$relatedElement),p=t(".datepickerwrapper-shortcuts",a.$relatedElement),u=t(".shortcut",p);a.options.shortcuts&&e.each(e.values(a.options.shortcuts),function(t,n){var s=!0;e.each(t,function(t,n){var r=i(a.options.dates[n],e.isString(a.options.dates[n])&&m);t.isSame(r,"days")||(s=!1)}),s&&u.eq(n).addClass("active").siblings().removeClass("active")}),e.each(o,function(n,s){t(n).val(i(a.options.dates[s],e.isString(a.options.dates[s])&&m).format(h))}),e.each(c,function(t,n){t.val(a.options.dates[n]).on("change.datepicker unchange.datepicker ",function(t,e,i){if(!(void 0!==i&&"date"!==i&&"time"!==i||a.options.typeMap.time&&"date"===i)){var s=a._unlimitFilter(e,a.options.unlimits[n]);o.eq(n).val(s),d.eq(n).hide()}});var s=a._unlimitFilter(i(a.options.dates[n],e.isString(a.options.dates[n])&&m),a.options.unlimits[n]);o.eq(n).val(s),t.$element.on("click",".timepicker .timepicker-footer .cancel",function(){d.eq(n).hide()})}),s&&s.resolve()})},_unlimitFilter:function(t,n){var s=this.options.typeMap,a=s.date&&s.time&&m||s.date&&h||s.time&&u,r=t.format(a);return n&&r===i(n,e.isString(n)&&m).format(a)&&(r="不限"),r},_inputToggleDatePicker:function(e,i,n){var s=t(".datepickerwrapper-inputs",this.$relatedElement),a=t(".datepickerwrapper-pickers",this.$relatedElement),r=t(".picker",a),o=s.offset();a.offset({left:o.left,top:o.top+s.outerHeight()+(parseInt(a.css("margin-top"),10)||0)});var l,d=r.eq(i),c=t(e.target),p=c.offset();switch(this.options.align){case"left":l=p.left;break;case"right":l=p.left-(d.outerWidth()-c.outerWidth())}d[n?n:"toggle"]().offset({left:l}).siblings().hide()},_hideDatePicker:function(){var e=t(".datepickerwrapper-pickers",this.$relatedElement),i=t(".picker",e);i.hide()},show:function(){this.$element.addClass("datepickerwrapper-open"),this.$relatedElement.show().offset(this._offset())},hide:function(){this.$element.removeClass("datepickerwrapper-open"),this._hideDatePicker(),this.$relatedElement.hide()},toggle:function(){this.$element.toggleClass("datepickerwrapper-open"),this.$relatedElement.toggle().offset(this._offset())},_offset:function(){var t=o(this.$element,this.$relatedElement,this.options.placement,this.options.align),e=parseInt(this.$relatedElement.css("margin-left"),10)||0,i=parseInt(this.$relatedElement.css("margin-top"),10)||0;return{left:t.left+e+(this.options.offset.left||0),top:t.top+i+(this.options.offset.top||0)}},submit:function(i,s){var a=this;switch(s){case"shortcut":break;default:var r=t(".datepickerwrapper-shortcuts",a.$relatedElement),o=t(".shortcut",r);o.removeClass("active")}var l=n.query("components/datepicker",this.$relatedElement),d=e.map(l,function(t){return t.val()});this.hide();var h=t.Event("change"+p);if(this.trigger(h,[d]),!h.isDefaultPrevented()){var u=t("[data-index]",this.$element);u.length?e.each(u,function(e,i){var n=t(e);i=+n.attr("data-index"),n[c.test(e.nodeName)?"val":"html"](a._unlimitFilter(d[i],a.options.unlimits[i]))}):this.$element[c.test(this.element.nodeName)?"val":"html"](e.map(d,function(t,e){return a._unlimitFilter(t,a.options.unlimits[e])}).join(", ")),u=t("[data-hidden-index]",this.$element),e.each(u,function(e,i){var n=t(e);i=+n.attr("data-hidden-index");var s=a._unlimitFilter(d[i],void 0);n.val(s).trigger("change")})}},shortcutText:function(t){var i;return e.each(this.options.shortcuts,function(n,s){if(!i){var a=!0;e.each(n,function(e,i){e.isSame(t[i],"days")||(a=!1)}),a&&(i=s)}}),i},_change:function(s,a,r){var o=this,l=t(s.target),d=n.query("components/datepicker",this.$relatedElement);switch(a){case"shortcut":var c=l.attr("data-value").split(",");e.each(c,function(t,e){o.options.dates[e]=t,d[e].val(t)}),l.addClass("active").siblings().removeClass("active"),this.submit(s,a);break;case"date":var p=i(l.val());if(!p.isValid())break;d[r].val(p)}},_autoHide:function(){var e=this,i="click"+p+"_"+this.clientId;this._state=g.INACTIVE,t(document.body).off(i).on(i,function(i){if(t.contains(document.body,i.target)){if(i.target===e.element||t.contains(e.element,i.target)||i.target===e.$relatedElement[0]||t.contains(e.$relatedElement[0],i.target)){if(e._state===g.ACTIVE)return;return e.trigger(t.Event("active"+p,{target:i.target})),void(e._state=g.ACTIVE)}if(e._state!==g.INACTIVE){var n=t.Event("inactive"+p,{target:i.target});e.trigger(n),e._state=g.INACTIVE,n.isDefaultPrevented()||e.hide()}}}).on(i,function(i){var n=t(".datepickerwrapper-inputs-body",e.$relatedElement),s=t(".datepickerwrapper-pickers",e.$relatedElement);i.target!==e.$relatedElement[0]&&!t.contains(e.$relatedElement[0],i.target)||!n.length||!s.length||t.contains(n[0],i.target)||t.contains(s[0],i.target)||e._hideDatePicker()})},destroy:function(){var e="click.datepickerwrapper_toggle_"+this.clientId;this.$element.off(e),this.$manager.undelegate(this.$element,this),this.$manager.undelegate(this.$relatedElement,this),this.$relatedElement.remove(),e="click"+p+"_"+this.clientId,t(document.body).off(e)}}),d});