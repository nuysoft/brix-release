define(["jquery","underscore","components/base","brix/event","./colorpicker.tpl.js"],function(t,e,o,s,i,r,a,c,n){function d(){}function h(t,e,o){var s,i,r,a,c;t=t%360/60,c=o*e,a=c*(1-Math.abs(t%2-1)),s=i=r=o-c,t=~~t,s+=[c,a,0,0,a,c][t],i+=[a,c,c,a,0,0][t],r+=[0,0,a,c,c,a][t];var n=255*s,d=255*i,h=255*r;return{r:n,g:d,b:h,hex:"#"+(16777216|h|d<<8|n<<16).toString(16).slice(1)}}function l(t,e,o){(t>1||e>1||o>1)&&(t/=255,e/=255,o/=255);var s,i,r,a;return r=Math.max(t,e,o),a=r-Math.min(t,e,o),s=0===a?null:r==t?(e-o)/a+(e<o?6:0):r==e?(o-t)/a+2:(t-e)/a+4,s=s%6*60,i=0===a?0:a/r,{h:s,s:i,v:r}}return r='            <svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="100%" height="100%">                <defs>                    <linearGradient id="gradient-hsv" x1="0%" y1="100%" x2="0%" y2="0%">                        <stop offset="0%" stop-color="#FF0000" stop-opacity="1"></stop>                        <stop offset="13%" stop-color="#FF00FF" stop-opacity="1"></stop>                        <stop offset="25%" stop-color="#8000FF" stop-opacity="1"></stop>                        <stop offset="38%" stop-color="#0040FF" stop-opacity="1"></stop>                        <stop offset="50%" stop-color="#00FFFF" stop-opacity="1"></stop>                        <stop offset="63%" stop-color="#00FF40" stop-opacity="1"></stop>                        <stop offset="75%" stop-color="#0BED00" stop-opacity="1"></stop>                        <stop offset="88%" stop-color="#FFFF00" stop-opacity="1"></stop>                        <stop offset="100%" stop-color="#FF0000" stop-opacity="1"></stop>                    </linearGradient>                </defs>                <rect x="0" y="0" width="100%" height="100%" fill="url(#gradient-hsv)"></rect>            </svg>        ',a='            <svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="100%" height="100%">                <defs>                    <lineargradient id="gradient-black" x1="0%" y1="100%" x2="0%" y2="0%">                        <stop offset="0%" stop-color="#000000" stop-opacity="1"></stop>                        <stop offset="100%" stop-color="#CC9A81" stop-opacity="0"></stop>                    </lineargradient>                    <lineargradient id="gradient-white" x1="0%" y1="100%" x2="100%" y2="100%">                        <stop offset="0%" stop-color="#FFFFFF" stop-opacity="1"></stop>                        <stop offset="100%" stop-color="#CC9A81" stop-opacity="0"></stop>                    </lineargradient>                </defs>                <rect x="0" y="0" width="100%" height="100%" fill="url(#gradient-white)"></rect>                <rect x="0" y="0" width="100%" height="100%" fill="url(#gradient-black)"></rect>            </svg>        ',c='            <div style="position: relative; width: 100%; height: 100%">                <v:rect style="position: absolute; top: 0; left: 0; width: 100%; height: 100%" stroked="f" filled="t">                    <v:fill type="gradient" method="none" angle="0" color="red" color2="red" colors="8519f fuchsia;.25 #8000ff;24903f #0040ff;.5 aqua;41287f #00ff40;.75 #0bed00;57671f yellow"></v:fill>                </v:rect>            </div>        ',n='            <div style="position: relative; width: 100%; height: 100%">                <v:rect style="position: absolute; left: -1px; top: -1px; width: 101%; height: 101%" stroked="f" filled="t">                    <v:fill type="gradient" method="none" angle="270" color="#FFFFFF" opacity="100%" color2="#CC9A81" o:opacity2="0%"></v:fill>                </v:rect>                <v:rect style="position: absolute; left: 0px; top: 0px; width: 100%; height: 101%" stroked="f" filled="t">                    <v:fill type="gradient" method="none" angle="0" color="#000000" opacity="100%" color2="#CC9A81" o:opacity2="0%"></v:fill>                </v:rect>            </div>        ',e.extend(d.prototype,o.prototype,{options:{color:"#ffffff"},init:function(){},render:function(){var o=this;this.$manager=new s("bx-"),this.color=this.options.color;var d=e.template(i)({colors:["#d81e06","#f4ea2a","#1afa29","#1296db","#13227a","#d4237a","#ffffff","#e6e6e6","#dbdbdb","#cdcdcd","#bfbfbf","#8a8a8a","#707070","#515151","#2c2c2c","#000000","#ea986c","#eeb174","#f3ca7e","#f9f28b","#c8db8c","#aad08f","#87c38f","#83c6c2","#7dc5eb","#87a7d6","#8992c8","#a686ba","#bd8cbb","#be8dbd","#e89abe","#e8989a","#e16632","#e98f36","#efb336","#f6ef37","#afcd51","#7cba59","#36ab60","#1baba8","#17ace3","#3f81c1","#4f68b0","#594d9c","#82529d","#a4579d","#db649b","#dd6572","#d81e06","#e0620d","#ea9518","#f4ea2a","#8cbb1a","#2ba515","#0e932e","#0c9890","#1295db","#0061b2","#0061b0","#004198","#122179","#88147f","#d3227b","#d6204b"],min:!1,color:this.color}),h=t(this.element),l=t(d).css({left:h.offset().left,top:h.offset().top+h.outerHeight()+1}).insertAfter(this.element).hide();this.relatedElement=l[0],this.pickerDragNode=l.find(".picker-indicator"),this.slideDragNode=l.find(".slide-indicator");var f=this.slideNode=l.find(".slide"),p=this.pickerNode=l.find(".picker"),g=window.SVGAngle||document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1")?"SVG":"VML";switch(g){case"SVG":f.append(r),p.append(a);break;default:document.namespaces.v||document.namespaces.add("v","urn:schemas-microsoft-com:vml","#default#VML"),f.html(c),p.html(n)}this.setHex(this.color);var u="click.colorpicker_"+this.clientId;t(document.body).off(u).on(u,function(t){o.element!==t.target&&(l.has(t.target).length||o.hide())}),this.$manager.delegate(this.element,this),this.$manager.delegate(this.relatedElement,this)},show:function(){t(this.relatedElement).show()},hide:function(){t(this.relatedElement).hide()},toggle:function(){var e=t(this.element);t(this.relatedElement).toggle().offset({left:e.offset().left,top:e.offset().top+e.outerHeight()+1})},setColor:function(e){var o=t(this.relatedElement);this.h=e.h%360,this.s=e.s,this.v=e.v;var s=h(this.h,this.s,this.v);this.slideDragNode.css({top:Math.round(this.h*this.slideNode.height()/360-5)});var i=Math.round(this.s*this.pickerNode.width()-5),r=Math.round((1-this.v)*this.pickerNode.height()-5);this.pickerDragNode.css({left:i,top:r,color:r>98?"#fff":"#000"}),this.pickerNode.css({"background-color":h(this.h,1,1).hex}),o.find(".colorpicker-footer span").css({"background-color":s.hex}),this.color=s.hex,o.find("li").removeClass("selected");var a=o.find("input");a.val()!==s.hex&&a.val(s.hex)},setHsv:function(t){this.setColor(t)},setRgb:function(t){this.setColor(l(t.r,t.g,t.b),t)},setHex:function(t){this.setColor(l(parseInt(t.substr(1,2),16),parseInt(t.substr(3,2),16),parseInt(t.substr(5,2),16)),void 0,t)},pickQuickColor:function(e,o){this.setHex(o),t(e.target).addClass("selected")},pickPaletteColor:function(t){var e=this.pickerNode.offset(),o=t.pageX-e.left,s=t.pageY-e.top,i=this.pickerNode.width(),r=this.pickerNode.height();this.setHsv({h:this.h,s:o/i,v:(r-s)/r})},dragPickerIndicator:function(e){var o=this;t(document.documentElement).css("cursor","pointer"),e.preventDefault(),t(document.body).on("mousemove.pickerDragNode",function(t){t.pageX-=5,t.pageY-=5;var e=o.pickerNode.offset(),s=o.pickerNode.width(),i=o.pickerNode.height(),r=t.pageX-e.left,a=t.pageY-e.top;r+5>s?r=s:r<0?r=0:r+=5,a+5>i?a=i:a<0?a=0:a+=5,o.setHsv({h:o.h,s:r/s,v:(i-a)/i})}).on("mouseup",function(){t(document.documentElement).css("cursor","auto"),t(document.body).off("mousemove.pickerDragNode")})},pickSlideColor:function(t){var e=this.slideNode.offset(),o=this.slideNode.height(),s=t.pageY-e.top>=o?o-1:t.pageY-e.top,i=s/o*360;this.setHsv({h:i,s:this.s,v:this.v})},dragSlideIndicator:function(e){var o=this;t(document.documentElement).css("cursor","pointer"),e.preventDefault(),t(document.body).on("mousemove.slideDragNode",function(t){t.pageX-=5,t.pageY-=5;var e=o.slideNode.offset(),s=o.slideNode.height(),i=t.pageY-e.top;i+5>s?i=s-1:i<0?i=0:i+=5,o.setHsv({h:i/o.slideNode.height()*360,s:o.s,v:o.v})}).on("mouseup",function(){t(document.documentElement).css("cursor","auto"),t(document.body).off("mousemove.slideDragNode")})},inputColor:function(e){var o=t(e.target).val();7===o.length&&this.color!==o&&this.setHex(o)},finishInputColor:function(e){var o=t(e.target).val();this.color!=o&&this.setHex(o)},submit:function(){var e=h(this.h,this.s,this.v),o={hex:e.hex,hsv:{h:this.h,s:this.s,v:this.v},rgb:{r:e.r,g:e.g,b:e.b}};this.trigger("change.colorpicker",o),t(this.element).triggerHandler("change"),this.hide()},destroy:function(){this.$manager.undelegate(this.element,this),this.$manager.undelegate(this.relatedElement,this),this.relatedElement.remove();var e="click.colorpicker_"+this.clientId;t(document.body).off(e)}}),d});