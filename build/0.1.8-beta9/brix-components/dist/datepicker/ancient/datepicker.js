define(["jquery","underscore","moment","components/base","brix/event","./datepicker.tpl.js"],function(t,e,a,n,i,r){function d(t){return a(t,e.isString(t)&&_.DATE_TIME)}function s(t,n){if(n=n||"day",e.isArray(t))return e.map(t,function(t){return s(t,n)});var i,r=e.isString(t);return t?r&&(i=y.exec(t))?a().add((i[1]+1)*i[2],n):a(t,r&&_.DATE_TIME):a()}function o(t){return t.day&&"day"||t.month&&"month"||t.year&&"year"||"day"}function h(){}var u=".datepicker",c="date year month day time hour minute second";c=e.object(e.map(c.split(/\s+/),function(t){return[t.toUpperCase(),t]}));var m="single multiple range";m=e.object(e.map(m.split(/\s+/),function(t){return[t.toUpperCase(),t]}));var l="year quarter month day hour minute second millisecond";l=e.object(e.map(l.split(/\s+/),function(t){return[t.toUpperCase(),t]}));var _={YYYY:"YYYY",YYYY_MM:"YYYY-MM",YYYY_MM_DD:"YYYY-MM-DD",DATE:"YYYY-MM-DD",TIME:"HH:mm:ss",DATE_TIME:"YYYY-MM-DD HH:mm:ss"},f=e.template('_active("<%= value %>", "<%= unit %>", "<%= pattern %>")'),p=20,y=/^([+-])=(\d+)(.*)/,g=e.map(e.range(1,13),function(t){return(t<10?"0":"")+t});return h.NAMESPACE=u,h.TYPES=c,h.MODES=m,h.UNITS=l,h.PATTERNS=_,h.parseTypeAsMap=function(t){e.indexOf(["all","",void 0],t)!==-1&&(t=e.values(c).join(" "));var a=e.object(e.map(t.split(/\s+/),function(t){return[t,!0]}));return a.year=a.date||a.year||a.month||a.day,a.month=a.date||a.month||a.day,a.day=a.date||a.day,a.time=a.time||a.hour||a.minute||a.second,a},e.extend(h.prototype,n.prototype,{options:{date:void 0,type:"date",range:[],excluded:[],unlimit:!1,pages:1,mode:"single",disabled:!1},init:function(){var t=this.options;t.range=e.flatten(t.range),t.excluded=e.flatten(t.excluded),t.unlimit&&(t.unlimit=d(t.unlimit));var n=this.data=this.data||{};n.options=t,n.moment=a,t.unlimit&&t.unlimit.isSame(n.date)&&(this.__unlimit=t.unlimit),n.modeMap={},n.modeMap[t.mode]=!0,n.typeMap=h.parseTypeAsMap(t.type);var i=n.modeMap,r=n.typeMap;r.time&&(t.mode="single",i.single=!0,i.multiple=i.range=!1),(i.multiple||i.range)&&(r.time=r.second=r.minute=r.hour=!1),r.day||(t.pages=1),this.data.date=this.__initDate(this.options.date,this.options.mode)},__initDate:function(t,n){return t?{single:d(t),multiple:e.isArray(t)?e.map(t,function(t){return d(t)}):[d(t)],range:e.isArray(t)?e.map(t,function(t){return d(t)}):[d(t),d(t)]}[n]:{single:a(),multiple:[a()],range:[a(),a()]}[n]},render:function(){this.$element=t(this.element).append(e.template(r)(this.data));var a=this.$manager=new i("bx-");a.delegate(this.$element,this),this.__renderYearPicker().__renderMonthPicker().__renderDayPicker().__renderTimePicker();var n=this.$element.find(".year-month-day-container"),d=e.reduce(n.find(".year-month-day"),function(e,a){return e+t(a).outerWidth()},0);d>n.width()&&n.width(d)},val:function(n){var i=this.data.date;if(!n)return this.__unlimit?a(this.__unlimit):e.isArray(i)?e.map(i,function(t){return a(t)}):a(i);var r=this.data.modeMap;(r.multiple||r.range)&&(e.isArray(n)||(n=[].slice.call(arguments,0))),this.__unlimit=!1;var d=this.__mode_hooks[this.options.mode],o=s(n),h=d.same(i,o),c=t.Event((h?"unchange":"change")+u);return this.trigger(c,[d.clone(o)]),c.isDefaultPrevented()?this:(h||(this.data.date=o,this.__renderYearPicker().__renderMonthPicker().__renderDayPicker().__renderTimePicker()),this)},range:function(t){return t?(this.options.range=e.flatten(t),this.__renderDayPicker(),this):this.options.range},excluded:function(t){return t?(this.options.excluded=e.flatten(t),this.__renderDayPicker(),this):this.options.excluded},_slide:function(e,a,n){if(e.target){var i=t(e.target).parents(".year-month-day"),r=i.siblings();r.find(".year").slideUp("fast"),r.find(".month").slideUp("fast"),r.find(".day").slideDown("fast")}var d=e.target?t(e.target).parents(".year-month-day"):this.$element.find(".year-month-day");e.target||(n=a,a=e),d.find(a).slideUp("fast"),d.find(n).slideDown("fast")},_moveYearPicker:function(e,n){var i=t(e.currentTarget).parents("[data-page]").data("page"),r=t(e.currentTarget).parents(".year-header").data("date");r=a(r,_.YYYY).add(n*p,"years"),this.__renderYearPicker(r,i)},_moveMonthPicker:function(e,n){var i=t(e.currentTarget).parents("[data-page]").data("page"),r=t(e.currentTarget).parents(".month-header").data("date");r=a(r,_.YYYY_MM).add(n,"years"),this.__renderMonthPicker(r,i)},_moveDayPicker:function(e,n){var i=t(e.target).parents(".year-month-day"),r=i.siblings();r.find(".year").slideUp("fast"),r.find(".month").slideUp("fast"),r.find(".day").slideDown("fast");var d=t(e.currentTarget).parents("[data-page]").data("page"),s=t(e.currentTarget).parents(".day-header").data("date");s=a(s,_.YYYY_MM).add(n,"months"),this.__renderDayPicker(s,d)},_active:function(n,i,r,d){n.preventDefault(),this.__cursor=t(n.currentTarget).parents("[data-page]").data("page"),this.__unlimit=!1;var s=this.__mode_hooks[this.options.mode],o=a(i,d),h=this.__isUnlimitMode()?a().startOf("day"):this.data.date,c=e.isArray(h)?e.map(h,function(t){return a(t)}):a(h),m=s.update(h,o,r),l=!e.isArray(m)&&m.isSame(c),_=t.Event((l?"unchange":"change")+u),f=!1,p=this.data.typeMap;switch(r){case"year":p.month||(f=!0);break;case"month":p.day||(f=!0);break;case"date":case"day":f=!0}if(!f||this.data.modeMap.range&&1===m.length||(this.trigger(_,[s.clone(m),r]),!_.isDefaultPrevented())){switch(f&&(this.data.date=m),r){case"month":this.data.typeMap.day&&this._slide(n,".month",".day");break;case"year":this.data.typeMap.month&&this._slide(n,".year",".month")}this.__renderDayPicker(o).__renderMonthPicker(o).__renderYearPicker(o)}},__mode_hooks:{single:{update:function(t,e,a){switch(t=this.clone(t),a){case"date":t.date(e.date());case"month":t.month(e.month());case"year":t.year(e.year())}return t},same:function(t,e){return e.isSame(t)},val:function(){},clone:function(t){return a(t)}},multiple:{update:function(t,e,n){t=this.clone(t),"date"===n&&(n="day");for(var i,r=0;r<t.length;r++)a(t[r]).isSame(e,n)&&(i=!0,t.splice(r--,1));return i?t:(t.push(e),t)},same:function(t,e){if(e.length!==t.length)return!1;for(var a=0;a<e.length;a++)if(!e[a].isSame(t[a]))return!1;return!0},clone:function(t){return e.map(t,function(t){return a(t)}).sort(function(t,e){return t.diff(e)})}},range:{update:function(t,e,a){switch(t=this.clone(t),t.length){case 0:case 1:t.push(e);break;case 2:t=[e.startOf(a)]}return t},same:function(t,e){if(e.length!==t.length)return!1;for(var a=0;a<e.length;a++)if(!e[a].isSame(t[a]))return!1;return!0},clone:function(t){return e.map(t,function(t){return a(t)}).sort(function(t,e){return t.diff(e)})}}},__isUnlimitMode:function(){return this.options.unlimit&&(this.__unlimit||this.options.unlimit.isSame(this.data.date))&&!0||!1},__renderYearPicker:function(n,i){n=void 0!==n?n:{single:this.data.date,multiple:this.data.date[this.data.date.length-1],range:this.data.date[this.data.date.length-1]}[this.options.mode]||a(),i=void 0!==i?i:this.__cursor||0;var r=this,d=this.__isUnlimitMode();d&&(n=a().startOf("day"));var s=this.$element.find(".year");return e.each(s,function(d,s){var o=a(e.isArray(n)?n[0]:n),h=t(d),u=h.data();switch(u.start=o.year()-o.year()%p,r.options.type){case"year":u.start=u.start+(s-i)*p;break;case"month":break;case"day":}u.end=u.start+p-1,h.attr("data-cache-start",u.start),h.attr("data-cache-end",u.end),r.__renderYearPickerTitle(h,o),r.__renderYearPickerContent(h,o)}),this},__renderYearPickerTitle:function(t,e){var a=t.data();t.find(".year-header").data("date",e.format(_.YYYY)).find(".year-header-title").text(a.start+" - "+a.end)},__renderYearPickerContent:function(e,n){for(var i=e.find(".year-body .year-body-content").empty(),r=e.data(),d="year",s=r.start;s<=r.end;s++)n.year(s),t("<span>").text(s).attr("data-value",s).addClass(n.isSame(a(),d)?"hover":"").addClass(this.__disabled(n,d)?"disabled":"").addClass(this.__actived(n,d)?"active":"").attr("bx-click",f({unit:d,value:n.format(_.YYYY),pattern:_.YYYY})).appendTo(i)},__renderMonthPicker:function(n,i){n=void 0!==n?n:{single:this.data.date,multiple:this.data.date[this.data.date.length-1],range:this.data.date[this.data.date.length-1]}[this.options.mode]||a(),i=void 0!==i?i:this.__cursor||0;var r=this,d=this.__isUnlimitMode();d&&(n=a().startOf("day"));var s=this.$element.find(".month");return e.each(s,function(d,s){var o=t(d),h=a(e.isArray(n)?n[0]:n).add(s-i,"months");r.__renderMonthPickerTitle(o,h),r.__renderMonthPickerContent(o,h)}),this},__renderMonthPickerTitle:function(t,e){t.find(".month-header").data("date",e.format(_.YYYY)).find(".month-header-title").text(e.format(_.YYYY))},__renderMonthPickerContent:function(e,n){for(var i="month",r=e.find(".month-body .month-body-content").empty(),d=0;d<g.length;d++)n.month(d),t("<span>").text(g[d]).attr("data-value",n.format(_.YYYY_MM)).addClass(n.isSame(a(),i)?"hover":"").addClass(this.__disabled(n,i)?"disabled":"").addClass(this.__actived(n,i)?"active":"").attr("bx-click",f({unit:i,value:n.format(_.YYYY_MM),pattern:_.YYYY_MM})).appendTo(r)},__renderDayPicker:function(n,i){n=void 0!==n?n:{single:this.data.date,multiple:this.data.date[this.data.date.length-1],range:this.data.date[this.data.date.length-1]}[this.options.mode]||a(),i=void 0!==i?i:this.__cursor||0;var r=this;this.__isUnlimitMode()&&(n=a().startOf("day"));var d=this.$element.find(".day");return e.each(d,function(d,s){var o=t(d),h=a(e.isArray(n)?n[0]:n).add(s-i,"months");r.__renderDayPickerTitle(o,h),r.__renderDayPickerContent(o,h)}),this},__renderDayPickerTitle:function(t,e){t.find(".day-header").data("date",e.format(_.YYYY_MM)).find(".day-header-title").text(e.format("YYYY - MM"))},__renderDayPickerContent:function(e,n){for(var i=a(n).date(1).day(),r=n.daysInMonth(),d="day",s=e.find(".day-body .day-body-content").empty(),o=0;o<i;o++)s.append('<span class="inactive">');for(var h=1;h<=r;h++)n.date(h),t("<span>").text(h).addClass(n.isSame(a(),d)?"hover":"").addClass(this.__disabled(n,d)?"disabled":"").addClass(this.__actived(n,d)?"active":"").attr("bx-click",f({unit:"date",value:n.format(_.YYYY_MM_DD),pattern:_.YYYY_MM_DD})).appendTo(s)},__renderTimePicker:function(){var t=a(this.data.date),e=this.$element.find(".hour-minute-second input");return e.eq(0).val(t.format("HH")),e.eq(1).val(t.format("mm")),e.eq(2).val(t.format("ss")),this},_changeTime:function(e,n,i,r){var d={38:1,40:-1};this.__unlimit=!1;var s=this.data.date;if(void 0===n&&void 0===i&&void 0===r){var o=t.Event("change"+u);return void this.trigger(o,[a(s),"time"])}var h=s.toDate().getTime();if("keydown"===e.type){if(!d[e.which])return;n=d[e.which]||0}"blur"!==e.type&&"focusout"!==e.type||(this.data.date.set(i,e.target.value),n=0),s.add(n,r),e.preventDefault(),e.stopPropagation();var c=s.toDate().getTime()===h,m=t.Event((c?"unchange":"change")+u);if(this.trigger(m,[a(s),i]),!m.isDefaultPrevented()&&!c){this.__renderTimePicker();var l=this;clearTimeout(this.__timer),this.__timer=setTimeout(function(){l.__renderYearPicker().__renderMonthPicker().__renderDayPicker()},100)}},__disabled:function(t,e){var a=this.options.range,n=this.options.excluded;return!this.__inRange(t,a,e)||this.__inExcluded(t,n,e)},__inRange:function(t,e,a){return this.__in(t,e,a,!0)},__inExcluded:function(t,e,a){return this.__in(t,e,a,!1)},__in:function(t,n,i,r){if(!n.length)return r;for(var s,h,u,c=o(this.data.typeMap),m=0;m<n.length;m+=2){if(s=n[m]&&(e.isString(n[m])&&(u=y.exec(n[m]))?a().add((u[1]+1)*u[2],c):d(n[m])),h=n[m+1]&&(e.isString(n[m+1])&&(u=y.exec(n[m+1]))?a().add((u[1]+1)*u[2],c):d(n[m+1])),s&&h){var l=[a.min(s,h),a.max(s,h)];s=l[0],h=l[1]}if((!s||t.isSame(s,i)||t.isAfter(s,i))&&(!h||t.isSame(h,i)||t.isBefore(h,i)))return!0}return!1},__actived:function(t,n){if(this.__isUnlimitMode())return!1;var i=this.data.date;switch(this.options.mode){case"single":return t.isSame(i,n);case"multiple":return e.find(i,function(e){return t.isSame(a(e),n)});case"range":return 1===i.length&&t.isSame(i[0],n)||2===i.length&&(t.isSame(a.min(i[0],i[1]),n)||t.isAfter(a.min(i[0],i[1]),n))&&(t.isSame(a.max(i[0],i[1]),n)||t.isBefore(a.max(i[0],i[1]),n))}return!1},_unlimit:function(){var e=this.options.unlimit,a=!!this.__unlimit;this.__unlimit=e,a=a?a:e.isSame(this.data.date);var n=t.Event((a?"unchange":"change")+u);this.trigger(n,[e,"date"]),n.isDefaultPrevented()||this.__renderYearPicker().__renderMonthPicker().__renderDayPicker()},destroy:function(){this.$manager.undelegate(this.$element,this)}}),h});