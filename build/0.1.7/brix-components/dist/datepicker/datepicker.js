define(["jquery","underscore","moment","components/base","brix/event","./datepicker.tpl.js"],function(t,e,i,a,n,r){function s(){}var d=".datepicker",h="second minute hour time date month year",o="YYYY-MM-DD",c="HH:mm:ss",m=o+" "+c;return s.NAMESPACE=d,s.TYPES=h,s.DATE_PATTERN=o,s.TIME_PATTERN=c,s.DATE_TIME_PATTERN=m,s.typeMap=function(t){-1!==e.indexOf(["all","",void 0],t)&&(t=h);var i={};return e.each(t.split(/\s+/),function(t){i[t]=!0}),i.time=i.time||i.hour||i.minute||i.second,i},e.extend(s.prototype,a.prototype,{options:{date:i(),type:"all",range:[],unlimit:!1},init:function(){this.options.range=e.flatten(this.options.range),this.options.unlimit&&(this.options.unlimit=i(this.options.unlimit,e.isString(this.options.unlimit)&&m)),this.data=this.data||{},this.data.options=this.options,this.data.moment=i,this.data.date=i(this.options.date,e.isString(this.options.date)&&m),this.options.unlimit&&this.options.unlimit.toDate().getTime()===this.data.date.toDate().getTime()&&(this.__unlimit=this.options.unlimit),this.data.typeMap=s.typeMap(this.options.type)},render:function(){this.$element=t(this.element).append(e.template(r)(this.data));var i=this.$manager=new n("bx-");i.delegate(this.$element,this),this._renderYearPicker()._renderMonthPicker()._renderDatePicker()._renderTimePicker()},val:function(a){var n=this.data.date.toDate().getTime();if(a){this.__unlimit=!1,this.data.date=i(a,e.isString(a)&&m);var r=this.data.date.toDate().getTime()===n,s=t.Event((r?"unchange":"change")+d);return this.trigger(s,i(this.data.date)),r||this._renderYearPicker()._renderMonthPicker()._renderDatePicker()._renderTimePicker(),this}return i(this.__unlimit||this.data.date)},range:function(t){return t?(this.options.range=e.flatten(t),this._renderDatePicker(),this):this.options.range},_slide:function(t,e,i){2==arguments.length&&(i=e,e=t),this.$element.find(e).slideUp("fast"),this.$element.find(i).slideDown("fast")},_move:function(e,a,n){var r=this.__isUnlimitMode();r&&(this.data.date=i().startOf("day")),this.__unlimit=!1;var s=this.data.date,h=s.toDate().getTime();if("period"===a)return void this._renderYearPicker(n)._renderDatePicker();s.add(n,a);var o=s.toDate().getTime()===h,c=t.Event((o?"unchange":"change")+d);this.trigger(c,[i(s),a]),o||this._renderYearPicker()._renderMonthPicker()._renderDatePicker()},_active:function(e,a){var n=this.__isUnlimitMode();n&&(this.data.date=i().startOf("day")),this.__unlimit=!1;var r=this.data.date,s=r.toDate().getTime(),h=t(e.target);r.set(a,+h.attr("data-value"));var o=r.toDate().getTime()===s,c=t.Event((o?"unchange":"change")+d);switch(this.trigger(c,[i(r),a]),o||this._renderYearPicker()._renderMonthPicker()._renderDatePicker(),a){case"year":if(this.data.typeMap.year)break;this._slide(".yearpicker",".monthpicker");break;case"month":if(this.data.typeMap.month)break;this._slide(".monthpicker",".datepicker")}},_hooks:{38:1,40:-1},_changeTime:function(e,a,n,r){this.__unlimit=!1;var s=this.data.date;if(void 0===a&&void 0===n&&void 0===r){var h=t.Event("change"+d);return void this.trigger(h,[i(s),"time"])}var o=s.toDate().getTime();if("keydown"===e.type){if(!this._hooks[e.which])return;a=this._hooks[e.which]||0}("blur"===e.type||"focusout"===e.type)&&(this.data.date.set(n,e.target.value),a=0),s.add(a,r),e.preventDefault(),e.stopPropagation();var c=s.toDate().getTime()===o,m=t.Event((c?"unchange":"change")+d);this.trigger(m,[i(s),n]),c||this._renderTimePicker()._renderYearPicker()._renderMonthPicker()._renderDatePicker()},_changeHour:function(t,e){this._changeTime(t,e,"hour","hours")},_changeMinute:function(t,e){this._changeTime(t,e,"minute","minutes")},_changeSecond:function(t,e){this._changeTime(t,e,"second","seconds")},__isUnlimitMode:function(){return this.options.unlimit&&(this.__unlimit||this.options.unlimit.toDate().getTime()===this.data.date.toDate().getTime())&&!0||!1},_renderYearPicker:function(e){e=e||0;var a=this.data.date,n=this.__isUnlimitMode();n&&(a=i().startOf("day"));var r=this.$element.find(".yearpicker .picker-header h4"),s=this.$element.find(".yearpicker .picker-body"),d=20,h=s.data(),o=a.get("year");h.start=(h.start||o-o%d)+e*d,h.end=h.start+d-1,r.text(h.start+" - "+h.end),s.empty();for(var c=h.start;c<=h.end;c++)t("<span>").text(c).attr("data-value",c).attr("bx-click",'_active("year")').addClass(n||o!==c?"":"active").appendTo(s);return this},_renderMonthPicker:function(){var a=this.data.date,n=this.__isUnlimitMode();n&&(a=i().startOf("day"));var r=this.$element.find(".monthpicker .picker-header h4"),s=this.$element.find(".monthpicker .picker-body");r.text(a.get("year")),s.empty();var d=function(){for(var t=[],e=1;12>=e;e++)t.push(10>e?"0"+e:e);return t}();return e.each(d,function(e,i){t("<span>").text(e).attr("data-value",i).addClass(n||a.get("month")!==i?"":"active").attr("bx-click",'_active("month")').appendTo(s)}),this},_renderDatePicker:function(){function a(t){if(!h.length)return!1;for(var a,r,s=i(n).startOf("day").set("date",t),d=0;d<h.length;d+=2){if(a=h[d]&&i(h[d],e.isString(h[d])&&m).startOf("day"),r=h[d+1]&&i(h[d+1],e.isString(h[d+1])&&m).startOf("day"),a&&r){var o=i.min(a,r),c=i.max(a,r);a=o,r=c}if(a&&r&&s.diff(a,"days")>=0&&s.diff(r,"days")<=0)return!1;if(a&&!r&&s.diff(a,"days")>=0)return!1;if(!a&&r&&s.diff(r,"days")<=0)return!1;if(!a&&!r)return!1}return!0}var n=this.data.date,r=this.__isUnlimitMode();r&&(n=i().startOf("day"));var s=n.daysInMonth(),d=i(n).date(1).day(),h=this.options.range,o=this.$element.find(".datepicker .picker-header h4"),c=this.$element.find(".datepicker .picker-body .datepicker-body-value");o.text(n.format("YYYY - MM")),c.empty();for(var u=0;d>u;u++)t('<span class="inactive">').appendTo(c);for(var p=1;s>=p;p++)t("<span>").text(p).attr("data-value",p).addClass(r||n.date()!==p?"":"active").addClass(a(p)?"disabled":"").attr("bx-click",'_active("date")').appendTo(c);return this},_renderTimePicker:function(){var t=i(this.data.date),e=this.$element.find(".timepicker div.timepicker-group input");return e.eq(0).val(t.format("HH")),e.eq(1).val(t.format("mm")),e.eq(2).val(t.format("ss")),this},_unlimit:function(){var e=this.options.unlimit;this.__unlimit=e;var i=e.isSame(this.data.date),a=t.Event((i?"unchange":"change")+d);this.trigger(a,[e,"date"]),this._renderYearPicker()._renderMonthPicker()._renderDatePicker()},destroy:function(){this.$manager.undelegate(this.$element,this)}}),s});