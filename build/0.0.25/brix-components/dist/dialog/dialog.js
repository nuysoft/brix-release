define(["jquery","underscore","components/base","brix/event","./position.js","./dialog.tpl.js"],function(t,e,i,o,s,n){function l(){arguments.length&&(this.options=e.extend({},this.options,arguments[0]),this.init(),this.render())}var h=150,d="swing",a=".dialog",r=[];return e.extend(l.prototype,i.prototype,{options:{placement:"right",align:"top",left:void 0,top:void 0,width:"auto",height:"auto",offset:{left:0,top:0},content:"",closable:!0,modal:!1,singleton:!0},init:function(){return this.$element=t(this.element||this.options.element),this.$manager=new o("bx-"),this.options.css&&require("css!"+this.options.css),-1===(""+this.options.content).indexOf("<")&&(this.options.content='<div class="dialog-body">'+this.options.content+"<div>"),this},render:function(){this.fill(),this.$manager.delegate(this.$element,this)},destroy:function(){this.close();var e="keyup.dialog_autohide_"+this.clientId;r.length||t(document.body).off(e),this.$manager&&this.$manager.undelegate(this.$element),this.$relatedElement.remove()},fill:function(){var i=e.template(n)(this.options);return this.options.singleton&&(this.$relatedElement=t("div.dialog.dialog-singleton"),this.$relatedElement.length||(this.$relatedElement=t(i).appendTo(document.body).hide())),this.options.singleton||this.$relatedElement&&this.$relatedElement.length||(this.$relatedElement=t(i).removeClass("dialog-singleton").appendTo(document.body).hide()),this.$relatedElement.removeClass("dialog-top dialog-bottom dialog-left dialog-right").addClass("dialog-"+this.options.placement).find(".dialog-close")[this.options.closable?"removeClass":"addClass"]("hide").end().find(".dialog-content").html(this.options.content),this.$relatedElement.css({width:this.options.width,height:this.options.height}),this.options.modal&&(this.$backdropElement=t(".dialog-backdrop"),this.$backdropElement.length||(this.$backdropElement=t('<div class="dialog-backdrop"></div>').hide().appendTo(document.body))),this.$manager.delegate(this.$relatedElement,this),this},open:function(){!this.element&&this.options.element&&this.options.element!==this.$element[0]&&(this.$element=t(this.options.element)),this.fill();var e=this._offset();return this.$relatedElement.show().stop().css(s.start(this.$relatedElement,e)).animate(s.end(this.$relatedElement,e),h,d),this.options.modal&&(t(document.body).addClass("modal-open"),this.$backdropElement.show()),this._autoHide(),r.push(this),this.trigger("open"+a),this},close:function(){if(!this.$relatedElement||!this.$relatedElement.length)return this;var i=this,o=this._offset();if(this.$relatedElement.stop().animate(s.start(this.$relatedElement,o),h,d,function(){i.$relatedElement.hide()}),r=e.without(r,this),this.options.modal){var n=e.filter(r,function(t){return t.options.modal?t:void 0}).length;n||(t(document.body).removeClass("modal-open"),this.$backdropElement.hide())}return this.trigger("close"+a),this},_offset:function(){var t=void 0!==this.options.left&&void 0!==this.options.top?{left:this.options.left,top:this.options.top}:s(this.$element,this.$relatedElement,this.options.placement,this.options.align);return t={left:t.left+(this.options.offset.left||0),top:t.top+(this.options.offset.top||0)}},_autoHide:function(){var e=this,i="keyup.dialog_autohide_"+this.clientId;t(document.body).off(i).on(i,function(t){if(27===t.keyCode){var i=r.pop();i?i.close():e.close()}})}}),l});