define(["jquery","underscore","components/base","brix/event","./dropdown.tpl.js"],function(e,t,n,i,a){function o(e){return e&&e.element&&"select"!==e.element.nodeName.toLowerCase()?new l:void 0}function l(){}var r=".dropdown";return t.extend(o.prototype,n.prototype,{options:{value:"",data:[]},init:function(){this.$element=e(this.element).hide(),this.options.data.length?this._fill():this.options.data=this._parseData(this.$element)},render:function(){var n=this,o=new i,l=t.extend({data:this.options.data,disabled:this.options.disabled||this.$element.prop("disabled")},function(){n.options.value&&n.$element.val(n.options.value);var t=n.$element.prop("selectedIndex"),i=e(n.element.options[-1!==t?t:0]);return{label:i.text(),value:i.attr("value")}}());this.$relatedElement=e(t.template(a)(l)).insertBefore(this.$element),o.delegate(this.$element,this),o.delegate(this.$relatedElement,this),this._autoHide()},toggle:function(){return this.$relatedElement.toggleClass("open"),this},show:function(){return this.$relatedElement.addClass("open"),this},hide:function(){return this.$relatedElement.removeClass("open"),this},val:function(n){var i=this,a=function(){var t=i.$element.prop("selectedIndex");return e(i.element.options[-1!==t?t:0]).attr("value")}();if(void 0===n)return a;var o;return t.isObject(n)?o=n:t.each(this.options.data,function(e){e.value==n&&(o=e),e.selected=e.value==n}),o.name=this.$element.attr("name"),o.value===a?this:(this.$relatedElement.find("button.dropdown-toggle > span.dropdown-toggle-label").text(o.label),this.$element.val(o.value),this.$relatedElement.find('ul.dropdown-menu li:has([value="'+a+'"])').removeClass("active"),this.$relatedElement.find('ul.dropdown-menu li:has([value="'+o.value+'"])').addClass("active"),this.trigger("change"+r,o),this.$element.triggerHandler("change"),this)},_select:function(t){var n=e(t.currentTarget),i={label:n.text(),value:n.attr("value")||n.text()};this.val(i),this.toggle(),n.parent().addClass("active").siblings().removeClass("active")},_parseData:function(n){var i=this,a=t.filter(n.children(),function(e){return/optgroup|option/i.test(e.nodeName)});return t.map(a,function(t){var n=e(t);return/optgroup/i.test(t.nodeName)?{label:n.attr("label"),children:i._parseOptions(n.children())}:i._parseOption(t)})},_parseOptions:function(e){var n=this;return t.map(e,function(e){return n._parseOption(e)})},_parseOption:function(t){var n=e(t);return n.hasClass("divider")?"divider":{label:n.text(),value:n.attr("value"),selected:n.prop("selected")}},_fill:function(){var n=this,i=this.$element.hide().empty();t.each(this.options.data,function(a){if(a.children&&a.children.length){var o=e("<optgroup>").attr("label",a.label);t.each(a.children,function(e){n._genOption(e).appendTo(o)}),o.appendTo(i)}else n._genOption(a).appendTo(i)})},_genOption:function(t){return e("<option>").attr("value",t.value).prop("selected",t.selected).text(t.label)},_responsive:function(){var t=e(window),n=this.$relatedElement,i=n.find("ul.dropdown-menu");e(window).on("scroll",function(){var e=n.offset(),a=e.top-t.scrollTop(),o=t.scrollTop()+t.height()-e.top-n.outerHeight(),l=o>=a?"button":"top";switch(l){case"button":i.css("max-height",a-10);break;case"top":i.css("max-height",o-10)}})},_autoHide:function(){var t=this,n="click.dropdown_autohide_"+this.clientId;e(document.body).off(n).on(n,function(e){t.$relatedElement.has(e.target).length||t.hide()})},destroy:function(){var t="click.dropdown_autohide_"+this.clientId;e(document.body).off(t)}}),t.extend(l.prototype,o.prototype,{init:function(){this.$element=e(this.element),this.$relatedElement=this.$element},render:function(){var e=this,t=new i("bx-");e.options.value&&e.val(e.options.value),this.$element.on("click","ul.dropdown-menu > li > a",function(t){e._select(t)}),t.delegate(this.$element,this),this._autoHide()},val:function(n){var i=this,a=function(){var e=i.$element.find("ul.dropdown-menu > li.active > a");return e.attr("value")||e.text()}();if(void 0===n)return a;var o;if(t.isObject(n))o=n;else{var l=i.$element.find("ul.dropdown-menu > li");t.each(l,function(t){var i=e(t).removeClass("active"),a=i.find("> a"),l=a.attr("value"),r=a.text();(l||r)==n&&(o={label:r,value:l||r},i.addClass("active"))})}return o.name=this.$element.attr("name"),o.value===a?this:(this.$element.find("button.dropdown-toggle > span.dropdown-toggle-label").text(o.label),this.trigger("change"+r,o),this)}}),o});