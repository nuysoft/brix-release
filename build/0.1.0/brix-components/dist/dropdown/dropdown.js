define(["jquery","underscore","components/base","brix/event","./dropdown.tpl.js"],function(e,t,n,a,i){function l(e){return e&&e.element&&"select"!==e.element.nodeName.toLowerCase()?new o:void 0}function o(){}var r=".dropdown";return t.extend(l.prototype,n.prototype,{options:{name:null,label:null,value:null,data:[],disabled:null},init:function(){this.$element=e(this.element).hide(),this.$manager=new a("bx-");var t=this.options;t.data.length?(this._fixFlattenData(this.options.data),this._fillSelect()):t.data=this._parseDataFromSelect(this.$element),t.disabled=this.$element.prop("disabled"),null!==t.value&&this.$element.val(t.value);var n=this.$element.find("option:selected");t.label=n.text(),t.value=n.attr("value"),t.name=this.$element.attr("name")},render:function(){this.$relatedElement=e(t.template(i)(this.options)).insertBefore(this.$element),this.$manager.delegate(this.$element,this),this.$manager.delegate(this.$relatedElement,this),this._autoHide()},toggle:function(){return this.$relatedElement.toggleClass("open"),this},show:function(){return this.$relatedElement.addClass("open"),this},hide:function(){return this.$relatedElement.removeClass("open"),this},val:function(e){var n=this.$element.val();if(void 0===e)return n;var a;return t.isObject(e)?a=e:t.each(this.options.data,function(t){t.value==e&&(a=t),t.selected=t.value==e}),a?""+a.value===n?this:(this.$relatedElement.find("button.dropdown-toggle > span.dropdown-toggle-label").text(a.label),this.$element.val(a.value),this.$relatedElement.find("ul.dropdown-menu").find('li:has([value="'+n+'"])').removeClass("active").end().find('li:has([value="'+a.value+'"])').addClass("active"),this.trigger("change"+r,a),this.$element.triggerHandler("change"),this):void 0},data:function(n){this.options.data=this._fixFlattenData(n),this._fillSelect();var a=this.$relatedElement.find("ul.dropdown-menu"),l=e(t.template(i)(this.options)).find("ul.dropdown-menu");a.replaceWith(l),this.$manager.delegate(this.$relatedElement,this)},select:function(t){var n=e(t.currentTarget),a={label:n.text(),value:n.attr("value")||n.text()};this.val(a),this.toggle(),n.closest("li").addClass("active").siblings().removeClass("active")},_parseDataFromSelect:function(n){function a(e){return t.map(e,function(e){return i(e)})}function i(t){var n=e(t);return n.hasClass("divider")?"divider":{label:n.text(),value:n.attr("value"),selected:n.prop("selected")}}var l=t.filter(n.children(),function(e){return/optgroup|option/i.test(e.nodeName)});return t.map(l,function(t){var n=e(t);return/optgroup/i.test(t.nodeName)?{label:n.attr("label"),children:a(n.children())}:i(t)})},_fixFlattenData:function(e){return t.map(e,function(e,n,a){return a[n]=t.isObject(e)?e:{label:e,value:e}})},_fillSelect:function(){function n(t){return e("<option>").attr("value",t.value).prop("selected",t.selected).text(t.label)}var a=this.$element.empty();t.each(this.options.data,function(i){if(i.children&&i.children.length){var l=e("<optgroup>").attr("label",i.label);t.each(i.children,function(e){n(e).appendTo(l)}),l.appendTo(a)}else n(i).appendTo(a)})},_responsive:function(){var t=e(window),n=this.$relatedElement,a=n.find("ul.dropdown-menu");e(window).on("scroll",function(){var e=n.offset(),i=e.top-t.scrollTop(),l=t.scrollTop()+t.height()-e.top-n.outerHeight(),o=l>=i?"button":"top";switch(o){case"button":a.css("max-height",i-10);break;case"top":a.css("max-height",l-10)}})},_autoHide:function(){var t=this,n="click.dropdown_autohide_"+this.clientId;e(document.body).off(n).on(n,function(e){t.$relatedElement.has(e.target).length||t.hide()})},destroy:function(){var t="click.dropdown_autohide_"+this.clientId;e(document.body).off(t)}}),t.extend(o.prototype,l.prototype,{init:function(){this.$element=e(this.element),this.$relatedElement=this.$element,this.$manager=new a("bx-"),this._fixFlattenData(this.options.data)},render:function(){this.options.value&&this.val(this.options.value),this.$manager.delegate(this.$relatedElement,this),this._autoHide()},val:function(n){var a=this,i=function(){var e=a.$element.find("ul.dropdown-menu > li.active > a");return e.attr("value")||e.text()}();if(void 0===n)return i;var l;return t.isObject(n)?l=n:t.each(a.$element.find("ul.dropdown-menu > li"),function(t){var a=e(t),i=a.find("> a"),o=i.attr("value"),r=i.text();(o||r)==n&&(l={label:r,value:o||r})}),l?""+l.value===i?this:(this.$relatedElement.find("button.dropdown-toggle > span.dropdown-toggle-label").text(l.label),this.$relatedElement.find("ul.dropdown-menu").find('li:has([value="'+i+'"])').removeClass("active").end().find('li:has([value="'+l.value+'"])').addClass("active"),this.trigger("change"+r,l),this):void 0},data:function(n){this.options.data=this._fixFlattenData(n);var a=this.$relatedElement.find("ul.dropdown-menu"),l=e(t.template(i)(this.options)).find("ul.dropdown-menu");a.replaceWith(l),this.$manager.delegate(this.$relatedElement,this)}}),l});